<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees IP Intelligence .NET: OnPremise/Metrics-Console/Program.cs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="/documentation/4.5/index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees IP Intelligence .NET
   &#160;<span id="projectnumber">4.5</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">IP intelligence services for 51Degrees Pipeline</div>
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_on_premise_2_metrics-_console_2_program_8cs-example.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="g-docs__header">
<h2 class="g-docs__page-title">OnPremise/Metrics-Console/Program.cs</h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<p>This example takes all public IP addresses and passes them to the IP Intelligence service, recording the average geographic area in square kilometers, the number of polygons that form the area, and the equivalent radius if the area can be represented as a circle.Depending on the available processor cores the example can take a long time to complete.</p>
<p>The sample of IP addresses used in the metrics can be adjusted as a parameter.</p>
<p>This example is primarily designed for those who are interested in verifying the published metrics associated with 51Degrees' IP intelligence service.</p>
<p>This example is available in full on <a href="https://github.com/51Degrees/ip-intelligence-dotnet-examples/blob/master/Examples/OnPremise/Metrics-Console/Program.cs">GitHub</a>.</p>
<p>This example requires an enterprise IP Intelligence data file (.ipi). To obtain an enterprise data file for testing, please <a href="https://51degrees.com/contact-us">contact us</a>.</p>
<p>Required NuGet Dependencies:</p><ul>
<li><a href="https://www.nuget.org/packages/FiftyOne.IpIntelligence/">FiftyOne.IpIntelligence</a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.Extensions.Logging.Console/">Microsoft.Extensions.Logging.Console</a> </li>
</ul>
<div class="c-code__block c-code__block--outline"><div class="c-code__line"><span class="c-code__comment">/* *********************************************************************</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is copyright of 51 Degrees Mobile Experts Limited.</span></div><div class="c-code__line"><span class="c-code__comment"> * Copyright 2025 51 Degrees Mobile Experts Limited, Davidson House,</span></div><div class="c-code__line"><span class="c-code__comment"> * Forbury Square, Reading, Berkshire, United Kingdom RG1 3EU.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is licensed under the European Union Public Licence</span></div><div class="c-code__line"><span class="c-code__comment"> * (EUPL) v.1.2 and is subject to its terms as set out below.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If a copy of the EUPL was not distributed with this file, You can obtain</span></div><div class="c-code__line"><span class="c-code__comment"> * one at https://opensource.org/licenses/EUPL-1.2.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * The &#39;Compatible Licences&#39; set out in the Appendix to the EUPL (as may be</span></div><div class="c-code__line"><span class="c-code__comment"> * amended by the European Commission) shall be deemed incompatible for</span></div><div class="c-code__line"><span class="c-code__comment"> * the purposes of the Work and the provisions of the compatibility</span></div><div class="c-code__line"><span class="c-code__comment"> * clause in Article 5 of the EUPL shall not apply.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If using the Work as, or as part of, a network application, by</span></div><div class="c-code__line"><span class="c-code__comment"> * including the attribution notice(s) required under Article 5 of the EUPL</span></div><div class="c-code__line"><span class="c-code__comment"> * in the end user terms of the application under an appropriate heading,</span></div><div class="c-code__line"><span class="c-code__comment"> * such notice(s) shall fulfill the requirements of that article.</span></div><div class="c-code__line"><span class="c-code__comment"> * ********************************************************************* */</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">using</span> CsvHelper;</div><div class="c-code__line"><span class="c-code__keyword">using</span> CsvHelper.Configuration;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Examples.OnPremise.Areas;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.<a class="code" href="namespace_fifty_one_1_1_ip_intelligence.html">IpIntelligence</a>.<a class="code" href="namespace_fifty_one_1_1_ip_intelligence_1_1_engine.html">Engine</a>.<a class="code" href="namespace_fifty_one_1_1_ip_intelligence_1_1_engine_1_1_on_premise.html">OnPremise</a>.<a class="code" href="namespace_fifty_one_1_1_ip_intelligence_1_1_engine_1_1_on_premise_1_1_flow_elements.html">FlowElements</a>;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Core.Data;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Core.FlowElements;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Engines;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Engines.Data;</div><div class="c-code__line"><span class="c-code__keyword">using</span> <a class="code" href="namespace_fifty_one.html">FiftyOne</a>.Pipeline.Engines.FiftyOne.Data;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Microsoft.Extensions.DependencyInjection;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Microsoft.Extensions.Hosting;</div><div class="c-code__line"><span class="c-code__keyword">using</span> Microsoft.Extensions.Logging;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Collections.Concurrent;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Collections.Generic;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Diagnostics;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Globalization;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.IO;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Linq;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Net;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Net.Sockets;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Runtime;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Threading;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Threading.Tasks;</div><div class="c-code__line"><span class="c-code__keyword">using</span> System.Threading.Tasks.Dataflow;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">namespace </span>FiftyOne.IpIntelligence.Examples.OnPremise.Metrics;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keyword">class </span><a name="_a0"></a><a class="code" href="class_extensions.html">Extensions</a></div><div class="c-code__line">{</div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> IEnumerable&lt;(string, string)&gt;</div><div class="c-code__line">        ValidRanges(<span class="c-code__keyword">this</span> IpiOnPremiseEngine engine)</div><div class="c-code__line">    {</div><div class="c-code__line">        var network = engine.Components.Single(i =&gt;</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;Network&quot;</span>.Equals(</div><div class="c-code__line">                i.Name,</div><div class="c-code__line">                StringComparison.InvariantCultureIgnoreCase));</div><div class="c-code__line">        <span class="c-code__keywordflow">foreach</span> (var profile <span class="c-code__keywordflow">in</span> engine.Profiles)</div><div class="c-code__line">        {</div><div class="c-code__line">            var range = GetRange(network, profile);</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (range.Item1 != <span class="c-code__keyword">null</span> &amp;&amp; range.Item2 != <span class="c-code__keyword">null</span>)</div><div class="c-code__line">            {</div><div class="c-code__line">                yield <span class="c-code__keywordflow">return</span> range;</div><div class="c-code__line">            }</div><div class="c-code__line">            profile.Dispose();</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> (string, string) GetRange(</div><div class="c-code__line">        IComponentMetaData network,</div><div class="c-code__line">        IProfileMetaData profile)</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (network.Equals(profile.Component) &amp;&amp;</div><div class="c-code__line">            profile.GetValue(<span class="c-code__stringliteral">&quot;RegisteredCountry&quot;</span>, <span class="c-code__stringliteral">&quot;Unknown&quot;</span>) == <span class="c-code__keyword">null</span>)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> GetRange(profile);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> <span class="c-code__keywordflow">default</span>;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> (string, string) GetRange(IProfileMetaData profile)</div><div class="c-code__line">    {</div><div class="c-code__line">        var start = profile.GetValues(<span class="c-code__stringliteral">&quot;IpRangeStart&quot;</span>).Single();</div><div class="c-code__line">        var end = profile.GetValues(<span class="c-code__stringliteral">&quot;IpRangeEnd&quot;</span>).Single();</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> <span class="c-code__keyword">new</span>(start.Name, end.Name);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">bool</span> <a name="a1"></a><a class="code" href="class_extensions.html#a7767954cb4226897a310649b2e17641c">TryGetNextAddress</a>(Span&lt;byte&gt; buffer)</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = buffer.Length - 1; i &gt;= 0; i--)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (buffer[i] &lt; <span class="c-code__keywordtype">byte</span>.MaxValue)</div><div class="c-code__line">            {</div><div class="c-code__line">                buffer[i]++;</div><div class="c-code__line">                <span class="c-code__keywordflow">return</span> <span class="c-code__keyword">true</span>;</div><div class="c-code__line">            }</div><div class="c-code__line">            buffer[i] = 0;</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> <span class="c-code__keyword">false</span>; <span class="c-code__comment">// Overflow</span></div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">bool</span> <a name="a2"></a><a class="code" href="class_extensions.html#a7533d059b15d1d1690abca59dbc3d4d2">IpEquals</a>(ReadOnlySpan&lt;byte&gt; a, ReadOnlySpan&lt;byte&gt; b)</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> a.SequenceEqual(b);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> IPAddress <a name="a3"></a><a class="code" href="class_extensions.html#a3d30fa9539a68a8099a1690caa230eac">GetNextAddress</a>(<span class="c-code__keyword">this</span> IPAddress ip)</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> ip.GetNextAddress(0);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> IPAddress <a class="code" href="class_extensions.html#a3d30fa9539a68a8099a1690caa230eac">GetNextAddress</a>(</div><div class="c-code__line">        <span class="c-code__keyword">this</span> IPAddress ip,</div><div class="c-code__line">        <span class="c-code__keywordtype">int</span> ignoreBytes)</div><div class="c-code__line">    {</div><div class="c-code__line">        IPAddress result = <span class="c-code__keyword">null</span>;</div><div class="c-code__line"></div><div class="c-code__line">        var bytes = ip.GetAddressBytes();</div><div class="c-code__line">        var newBytes = <span class="c-code__keyword">new</span> <span class="c-code__keywordtype">byte</span>[bytes.Length];</div><div class="c-code__line"></div><div class="c-code__line">        var added = <span class="c-code__keyword">false</span>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Work through the IP address bytes from least significant </span></div><div class="c-code__line">        <span class="c-code__comment">// to most significant.</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (var i = newBytes.Length - 1; i &gt;= 0; i--)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// If we&#39;ve already added to a byte or if this byte</span></div><div class="c-code__line">            <span class="c-code__comment">// is being ignored, just copy the existing byte value </span></div><div class="c-code__line">            <span class="c-code__comment">// to the new array.</span></div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (added || newBytes.Length - i &lt;= ignoreBytes)</div><div class="c-code__line">            {</div><div class="c-code__line">                newBytes[i] = bytes[i];</div><div class="c-code__line">            }</div><div class="c-code__line">            <span class="c-code__comment">// Otherwise, either add one to the byte value or, if it&#39;s </span></div><div class="c-code__line">            <span class="c-code__comment">// already 255, set it to 0.</span></div><div class="c-code__line">            <span class="c-code__keywordflow">else</span></div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (bytes[i] == <span class="c-code__keywordtype">byte</span>.MaxValue)</div><div class="c-code__line">                {</div><div class="c-code__line">                    newBytes[i] = 0;</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                {</div><div class="c-code__line">                    newBytes[i] = (byte)(bytes[i] + 1);</div><div class="c-code__line">                    added = <span class="c-code__keyword">true</span>;</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__comment">// As long as we&#39;ve managed to add to one of the bytes, set the</span></div><div class="c-code__line">        <span class="c-code__comment">// result from the new byte array.</span></div><div class="c-code__line">        <span class="c-code__comment">// Otherwise, return null. </span></div><div class="c-code__line">        <span class="c-code__comment">// (e.g. if the provided IP was 255.255.255.255)</span></div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (added != <span class="c-code__keyword">false</span>)</div><div class="c-code__line">        {</div><div class="c-code__line">            result = <span class="c-code__keyword">new</span> IPAddress(newBytes);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> result;</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span><a name="_a4"></a><a class="code" href="class_program.html">Program</a></div><div class="c-code__line">{</div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> readonly TimeSpan _logBuild = TimeSpan.FromSeconds(30);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">private</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">double</span> DEFAULT_SAMPLE_PERCENTAGE = 0.1;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Counter</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">int</span> Value = 1;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Metric</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> readonly <span class="c-code__keywordtype">string</span>[] <a name="a5"></a><a class="code" href="class_program_1_1_metric.html#a1d751450a4a5c16f60ea8589f04f2f28">Properties</a> = [</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;IpCount&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;AverageAreaKm&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;EquivalentRadiusKm&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;AveragePolygons&quot;</span>];</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">long</span> <a name="a6"></a><a class="code" href="class_program_1_1_metric.html#a2ec9dc8e4b2a8de390ed807b1279f709">TotalAreaKm</a> = 0;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">int</span> <a name="a7"></a><a class="code" href="class_program_1_1_metric.html#ad46b4bef0c832954cd6f40a899f72698">AreaCount</a> = 0;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">int</span> <a name="a8"></a><a class="code" href="class_program_1_1_metric.html#aa04227f0ee7b5ebb62942147b8b94b47">IpCount</a> = 0;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">long</span> <a name="a9"></a><a class="code" href="class_program_1_1_metric.html#acd60356a37fca05166bbe958a7790110">AverageAreaKm</a> =&gt;</div><div class="c-code__line">            <a class="code" href="class_program_1_1_metric.html#ad46b4bef0c832954cd6f40a899f72698">AreaCount</a> &gt; 0 ? <a class="code" href="class_program_1_1_metric.html#a2ec9dc8e4b2a8de390ed807b1279f709">TotalAreaKm</a> / <a class="code" href="class_program_1_1_metric.html#ad46b4bef0c832954cd6f40a899f72698">AreaCount</a> : 0;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">int</span> <a name="a10"></a><a class="code" href="class_program_1_1_metric.html#a9d171fe15c4badae4506f482010f0e93">EquivalentRadiusKm</a> =&gt;</div><div class="c-code__line">            (int)Math.Sqrt(<a class="code" href="class_program_1_1_metric.html#acd60356a37fca05166bbe958a7790110">AverageAreaKm</a> / Math.PI);</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> IReadOnlyDictionary&lt;int, int&gt; <a name="a11"></a><a class="code" href="class_program_1_1_metric.html#ae239d7430221f70ebf5104814addea1e">Polygons</a> =&gt;</div><div class="c-code__line">            _polygons.ToDictionary(k =&gt; k.Key, v =&gt; v.Value.Value);</div><div class="c-code__line">        <span class="c-code__keyword">private</span> Dictionary&lt;int, Counter&gt; _polygons = [];</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">double</span> <a name="a12"></a><a class="code" href="class_program_1_1_metric.html#a341fa7841fa77b2dd2df3ef9496d706c">AveragePolygons</a></div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keyword">get</span></div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (<a class="code" href="class_program_1_1_metric.html#ae239d7430221f70ebf5104814addea1e">Polygons</a>.Count == 0)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keywordflow">return</span> 0;</div><div class="c-code__line">                }</div><div class="c-code__line">                var weightedSum = <a class="code" href="class_program_1_1_metric.html#ae239d7430221f70ebf5104814addea1e">Polygons</a>.Sum(i =&gt; i.Key * i.Value);</div><div class="c-code__line">                var total = <a class="code" href="class_program_1_1_metric.html#ae239d7430221f70ebf5104814addea1e">Polygons</a>.Sum(i =&gt; i.Value);</div><div class="c-code__line">                <span class="c-code__keywordflow">return</span> (<span class="c-code__keywordtype">double</span>)weightedSum / total;</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">override</span> <span class="c-code__keywordtype">string</span> ToString() =&gt;</div><div class="c-code__line">            $<span class="c-code__stringliteral">&quot;{IpCount},{AverageAreaKm},{EquivalentRadiusKm},&quot;</span> +</div><div class="c-code__line">            $<span class="c-code__stringliteral">&quot;{AveragePolygons.ToString(&quot;</span>0.##<span class="c-code__stringliteral">&quot;)}&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">void</span> <a name="a13"></a><a class="code" href="class_program_1_1_metric.html#a0ec46279ff49602bfe596b66adabda13">IncrementPolygons</a>(<span class="c-code__keywordtype">int</span> polygons)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (_polygons.TryGetValue(polygons, out var counter))</div><div class="c-code__line">            {</div><div class="c-code__line">                counter.Value++;</div><div class="c-code__line">            }</div><div class="c-code__line">            <span class="c-code__keywordflow">else</span></div><div class="c-code__line">            {</div><div class="c-code__line">                _polygons.Add(polygons, <span class="c-code__keyword">new</span> Counter());</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">void</span> <a name="a14"></a><a class="code" href="class_program_1_1_metric.html#a027327361663d36392f2dfe0a9011889">Merge</a>(Metric other)</div><div class="c-code__line">        {</div><div class="c-code__line">            <a class="code" href="class_program_1_1_metric.html#aa04227f0ee7b5ebb62942147b8b94b47">IpCount</a> += other.IpCount;</div><div class="c-code__line">            <a class="code" href="class_program_1_1_metric.html#ad46b4bef0c832954cd6f40a899f72698">AreaCount</a> += other.AreaCount;</div><div class="c-code__line">            <a class="code" href="class_program_1_1_metric.html#a2ec9dc8e4b2a8de390ed807b1279f709">TotalAreaKm</a> += other.TotalAreaKm;</div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var pair <span class="c-code__keywordflow">in</span> other._polygons)</div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (_polygons.TryGetValue(pair.Key, out var counter))</div><div class="c-code__line">                {</div><div class="c-code__line">                    counter.Value += pair.Value.Value;</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                {</div><div class="c-code__line">                    _polygons.Add(pair.Key, pair.Value);</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>KeyFactory</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> readonly <span class="c-code__keywordtype">string</span>[] <a name="a15"></a><a class="code" href="class_program_1_1_key_factory.html#a16e65d282e7ec26ffdf4935b512e6150">Keys</a> = [</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;ContinentName&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;Country&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;LocationConfidence&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;ConnectionType&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;IsVPN&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;IsProxy&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;IsTor&quot;</span>,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;IsPublicRouter&quot;</span>];</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">string</span> <a name="a16"></a><a class="code" href="class_program_1_1_key_factory.html#ad043ae94c0a34cf9ab55aae790546fd4">Create</a>(IIpIntelligenceData data)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> <span class="c-code__keywordtype">string</span>.Join(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;,&quot;</span>,</div><div class="c-code__line">                <a class="code" href="class_program_1_1_key_factory.html#a16e65d282e7ec26ffdf4935b512e6150">Keys</a>.Select(i =&gt; GetValue(data[i])));</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">string</span> GetValue(<span class="c-code__keywordtype">object</span> obj)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> obj <span class="c-code__keywordflow">switch</span></div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__comment">// Single value</span></div><div class="c-code__line">                IAspectPropertyValue&lt;string&gt; </div><div class="c-code__line">                { HasValue: <span class="c-code__keyword">true</span>, Value: var str } =&gt; str,</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// weighted string </span></div><div class="c-code__line">                IAspectPropertyValue&lt;IReadOnlyList&lt;IWeightedValue&lt;string&gt;&gt;&gt; </div><div class="c-code__line">                { HasValue: <span class="c-code__keyword">true</span>, Value: { Count: 1 } list }</div><div class="c-code__line">                    =&gt; list[0].Value,</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// weighted bool</span></div><div class="c-code__line">                IAspectPropertyValue&lt;IReadOnlyList&lt;IWeightedValue&lt;bool&gt;&gt;&gt; </div><div class="c-code__line">                { HasValue: <span class="c-code__keyword">true</span>, Value: { Count: 1 } list }</div><div class="c-code__line">                    =&gt; list[0].Value.ToString(),</div><div class="c-code__line"></div><div class="c-code__line">                <span class="c-code__comment">// default</span></div><div class="c-code__line">                _ =&gt; <span class="c-code__stringliteral">&quot;Missing&quot;</span></div><div class="c-code__line">            };</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Consumer</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> Task&lt;IReadOnlyDictionary&lt;string, Metric&gt;&gt; <a name="a17"></a><a class="code" href="class_program_1_1_consumer.html#aa4e47e2256d8acf624354e365c21c1c2">Task</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">int</span> <a name="a18"></a><a class="code" href="class_program_1_1_consumer.html#ae2b85450219c17ff8d00215dab84c01c">Count</a>;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>AreaIndex</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> readonly <span class="c-code__keywordtype">string</span>[] <a name="a19"></a><a class="code" href="class_program_1_1_area_index.html#a009b5bb9307f563d5c0de4be2ae9afb1">Properties</a> = [<span class="c-code__stringliteral">&quot;Areas&quot;</span>];</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> IReadOnlyDictionary&lt;string, Result&gt; <a name="a20"></a><a class="code" href="class_program_1_1_area_index.html#afce3816ee598a1535e9e339e2238d00b">WktAreas</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> AreaIndex(</div><div class="c-code__line">            IFiftyOneAspectPropertyMetaData property,</div><div class="c-code__line">            ILogger logger,</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            <a class="code" href="class_program_1_1_area_index.html#afce3816ee598a1535e9e339e2238d00b">WktAreas</a> = BuildWktAreas(property, logger, stoppingToken);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> IReadOnlyDictionary&lt;string, Result&gt; BuildWktAreas(</div><div class="c-code__line">            IFiftyOneAspectPropertyMetaData property,</div><div class="c-code__line">            ILogger logger,</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            var wktAreas = <span class="c-code__keyword">new</span> ConcurrentDictionary&lt;string, Result&gt;();</div><div class="c-code__line">            var wktAreasTasks = <span class="c-code__keyword">new</span> BlockingCollection&lt;Task&gt;(</div><div class="c-code__line">                Environment.ProcessorCount);</div><div class="c-code__line"></div><div class="c-code__line">            var producer = Task.Run(() =&gt;</div><div class="c-code__line">                AddAreas(</div><div class="c-code__line">                    property,</div><div class="c-code__line">                    wktAreas,</div><div class="c-code__line">                    wktAreasTasks,</div><div class="c-code__line">                    stoppingToken),</div><div class="c-code__line">                stoppingToken);</div><div class="c-code__line"></div><div class="c-code__line">            var nextLog = DateTime.UtcNow.Add(_logBuild);</div><div class="c-code__line">            <span class="c-code__keywordflow">while</span> (wktAreasTasks.IsCompleted == <span class="c-code__keyword">false</span> &amp;&amp;</div><div class="c-code__line">                wktAreasTasks.TryTake(out var task, -1, stoppingToken))</div><div class="c-code__line">            {</div><div class="c-code__line">                task.Wait(stoppingToken);</div><div class="c-code__line">                <span class="c-code__keywordflow">if</span> (DateTime.UtcNow &gt;= nextLog)</div><div class="c-code__line">                {</div><div class="c-code__line">                    logger.LogInformation(</div><div class="c-code__line">                        <span class="c-code__stringliteral">&quot;Mapped &#39;{0}&#39; areas&quot;</span>,</div><div class="c-code__line">                        wktAreas.Count);</div><div class="c-code__line">                    nextLog = DateTime.UtcNow.Add(_logBuild);</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            producer.Wait(stoppingToken);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> wktAreas;</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> AddAreas(</div><div class="c-code__line">            IFiftyOneAspectPropertyMetaData property,</div><div class="c-code__line">            ConcurrentDictionary&lt;string, Result&gt; wktAreas,</div><div class="c-code__line">            BlockingCollection&lt;Task&gt; wktAreasTasks,</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var area <span class="c-code__keywordflow">in</span> property.GetValues())</div><div class="c-code__line">            {</div><div class="c-code__line">                wktAreasTasks.TryAdd(Task.Run(() =&gt;</div><div class="c-code__line">                    AddAreas(wktAreas, area.Name), stoppingToken),</div><div class="c-code__line">                    -1, stoppingToken);</div><div class="c-code__line">            }</div><div class="c-code__line">            wktAreasTasks.CompleteAdding();</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> AddAreas(</div><div class="c-code__line">            ConcurrentDictionary&lt;string, Result&gt; areas,</div><div class="c-code__line">            <span class="c-code__keywordtype">string</span> wkt)</div><div class="c-code__line">        {</div><div class="c-code__line">            areas.GetOrAdd(wkt, (_) =&gt; <a name="_a21"></a><a class="code" href="class_calculations.html">Calculations</a>.<a name="a22"></a><a class="code" href="class_calculations.html#a893bfd8981a3cd36cd213706b1b5b561">GetAreas</a>(wkt, 0, 0));</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Configuration</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">string</span> <a name="a23"></a><a class="code" href="class_program_1_1_configuration.html#a615a45e75f8ab706ccf67a5e7e7fe8bc">DataFile</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> StreamWriter <a name="a24"></a><a class="code" href="class_program_1_1_configuration.html#a847167efb959f576e62709e9315405b6">Output</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keywordtype">double</span> <a name="a25"></a><a class="code" href="class_program_1_1_configuration.html#af4cc244e8f562dea084f51d59bb7157f">SamplePercentage</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">public</span> ILoggerFactory <a name="a26"></a><a class="code" href="class_program_1_1_configuration.html#a47de969dc8063ea3e53b1d84d87be5b0">LoggerFactory</a>;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> sealed <span class="c-code__keyword">class </span><a name="a27"></a><a class="code" href="class_program.html#a898dc758806b6d5937f2fd6382eebd91">Worker</a>(</div><div class="c-code__line">        IHostApplicationLifetime hostApplicationLifetime,</div><div class="c-code__line">        Configuration configuration)</div><div class="c-code__line">        : BackgroundService</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">protected</span> <span class="c-code__keyword">override</span> async Task ExecuteAsync(</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            await Example.Run(</div><div class="c-code__line">                configuration.DataFile,</div><div class="c-code__line">                configuration.LoggerFactory,</div><div class="c-code__line">                configuration.Output,</div><div class="c-code__line">                configuration.SamplePercentage,</div><div class="c-code__line">                stoppingToken);</div><div class="c-code__line">            hostApplicationLifetime.StopApplication();</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">public</span> <span class="c-code__keyword">class </span>Example : ExampleBase</div><div class="c-code__line">    {</div><div class="c-code__line">        <span class="c-code__keyword">public</span> <span class="c-code__keyword">static</span> async Task Run(</div><div class="c-code__line">            <span class="c-code__keywordtype">string</span> dataFile,</div><div class="c-code__line">            ILoggerFactory loggerFactory,</div><div class="c-code__line">            TextWriter output,</div><div class="c-code__line">            <span class="c-code__keywordtype">double</span> samplePercentage,</div><div class="c-code__line">            CancellationToken stoppingToken,</div><div class="c-code__line">            ILogger logger = <span class="c-code__keyword">null</span>)</div><div class="c-code__line">        {</div><div class="c-code__line">            logger ??= loggerFactory.CreateLogger&lt;Example&gt;();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Ensure that batch latency mode is always enabled.</span></div><div class="c-code__line">            GCSettings.LatencyMode = GCLatencyMode.Batch;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Build a new on-premise IP Intelligence engine with the max</span></div><div class="c-code__line">            <span class="c-code__comment">// performance profile.</span></div><div class="c-code__line">            <span class="c-code__keyword">using</span> var ipiEngine = <span class="c-code__keyword">new</span> IpiOnPremiseEngineBuilder(loggerFactory)</div><div class="c-code__line">                <span class="c-code__comment">// We use the max performance profile for optimal detection</span></div><div class="c-code__line">                <span class="c-code__comment">// speed in this example. See the documentation for more detail</span></div><div class="c-code__line">                <span class="c-code__comment">// on this and other configuration options.</span></div><div class="c-code__line">                <span class="c-code__comment">// https://51degrees.com/documentation/_features__automatic_datafile_updates.html</span></div><div class="c-code__line">                .SetPerformanceProfile(PerformanceProfiles.MaxPerformance)</div><div class="c-code__line">                <span class="c-code__comment">// inhibit auto-update of the data file for this test</span></div><div class="c-code__line">                .SetAutoUpdate(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">                .SetDataFileSystemWatcher(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">                .SetDataUpdateOnStartup(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">                <span class="c-code__comment">// Set to only return from processing the properties needed.</span></div><div class="c-code__line">                .SetProperties(</div><div class="c-code__line">                    KeyFactory.Keys.Concat(AreaIndex.Properties).ToList())</div><div class="c-code__line">                <span class="c-code__comment">// Optimize for the expected parallel workload.</span></div><div class="c-code__line">                .SetConcurrency((ushort)Environment.ProcessorCount)</div><div class="c-code__line">                .Build(dataFile, <span class="c-code__keyword">false</span>);</div><div class="c-code__line">            <span class="c-code__keyword">using</span> var pipeline = <span class="c-code__keyword">new</span> PipelineBuilder(loggerFactory)</div><div class="c-code__line">                .AddFlowElement(ipiEngine)</div><div class="c-code__line">                .SetAutoDisposeElements(<span class="c-code__keyword">false</span>)</div><div class="c-code__line">                .Build();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Log data file information</span></div><div class="c-code__line">            var dataFilePublishDate = ipiEngine.DataFiles[0].DataPublishedDateTime;</div><div class="c-code__line">            var dataFileTier = ipiEngine.DataSourceTier;</div><div class="c-code__line">            logger.LogInformation(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;Using data file: {0} (tier: {1}, published: {2:yyyy-MM-dd})&quot;</span>,</div><div class="c-code__line">                dataFile,</div><div class="c-code__line">                dataFileTier,</div><div class="c-code__line">                dataFilePublishDate);</div><div class="c-code__line"></div><div class="c-code__line">            logger.LogInformation(<span class="c-code__stringliteral">&quot;Server GC: &#39;{0}&#39;&quot;</span>, GCSettings.IsServerGC);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Create the data set structure to rapidly retrieve the data</span></div><div class="c-code__line">            <span class="c-code__comment">// needed to calculate the metrics and to determine the valid</span></div><div class="c-code__line">            <span class="c-code__comment">// IP ranges.</span></div><div class="c-code__line">            logger.LogInformation(<span class="c-code__stringliteral">&quot;Creating area index&quot;</span>);</div><div class="c-code__line">            var areaIndex = <span class="c-code__keyword">new</span> AreaIndex(</div><div class="c-code__line">                ipiEngine.Properties.Single(i =&gt; <span class="c-code__stringliteral">&quot;Areas&quot;</span>.Equals(</div><div class="c-code__line">                    i.Name,</div><div class="c-code__line">                    StringComparison.InvariantCultureIgnoreCase)),</div><div class="c-code__line">                logger,</div><div class="c-code__line">                stoppingToken);</div><div class="c-code__line">            logger.LogInformation(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;Created index for &#39;{0}&#39; areas&quot;</span>,</div><div class="c-code__line">                areaIndex.WktAreas.Count);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Perform IP lookup for all the IP addresses in the ranges</span></div><div class="c-code__line">            <span class="c-code__comment">// and record the results.</span></div><div class="c-code__line">            var factory = <span class="c-code__keyword">new</span> KeyFactory();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Create a collection of ranges to ensure that there are always</span></div><div class="c-code__line">            <span class="c-code__comment">// items available for the consumers.</span></div><div class="c-code__line">            var ranges =</div><div class="c-code__line">                <span class="c-code__keyword">new</span> BlockingCollection&lt;(string, string)&gt;(</div><div class="c-code__line">                Environment.ProcessorCount);</div><div class="c-code__line">            var consumers = CreateConsumers(</div><div class="c-code__line">                pipeline,</div><div class="c-code__line">                areaIndex,</div><div class="c-code__line">                factory,</div><div class="c-code__line">                ranges,</div><div class="c-code__line">                samplePercentage,</div><div class="c-code__line">                stoppingToken);</div><div class="c-code__line">            logger.LogInformation(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;Created &#39;{0}&#39; consumer processors sampling &#39;{1:P2}&#39; of IPs&quot;</span>,</div><div class="c-code__line">                consumers.Length,</div><div class="c-code__line">                samplePercentage);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Use the main thread as the producer adding ranges for the</span></div><div class="c-code__line">            <span class="c-code__comment">// consumers to process.</span></div><div class="c-code__line">            AddRanges(</div><div class="c-code__line">                ipiEngine,</div><div class="c-code__line">                logger, </div><div class="c-code__line">                ranges,</div><div class="c-code__line">                consumers,</div><div class="c-code__line">                stoppingToken);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Combine all the consumer groups into the main groups.</span></div><div class="c-code__line">            var groups = <span class="c-code__keyword">new</span> Dictionary&lt;string, Metric&gt;();</div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var consumer <span class="c-code__keywordflow">in</span> consumers)</div><div class="c-code__line">            {</div><div class="c-code__line">                await consumer.Task;</div><div class="c-code__line">                logger.LogInformation(</div><div class="c-code__line">                    <span class="c-code__stringliteral">&quot;Finished consumer &#39;{0}&#39;&quot;</span>,</div><div class="c-code__line">                    consumer.Task.Id);</div><div class="c-code__line">                <span class="c-code__keywordflow">foreach</span> (var group <span class="c-code__keywordflow">in</span> consumer.Task.Result)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (groups.TryGetValue(group.Key, out var metric))</div><div class="c-code__line">                    {</div><div class="c-code__line">                        metric.Merge(group.Value);</div><div class="c-code__line">                    }</div><div class="c-code__line">                    <span class="c-code__keywordflow">else</span></div><div class="c-code__line">                    {</div><div class="c-code__line">                        groups.Add(group.Key, group.Value);</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            WriteToCsv(output, groups);</div><div class="c-code__line"></div><div class="c-code__line">            ExampleUtils.CheckDataFile(</div><div class="c-code__line">                ipiEngine,</div><div class="c-code__line">                loggerFactory.CreateLogger&lt;<a class="code" href="class_program.html">Program</a>&gt;());</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> WriteToCsv(TextWriter output, Dictionary&lt;string, Metric&gt; groups)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keyword">using</span> var writer = <span class="c-code__keyword">new</span> CsvWriter(</div><div class="c-code__line">                output,</div><div class="c-code__line">                <span class="c-code__keyword">new</span> CsvConfiguration(CultureInfo.InvariantCulture)</div><div class="c-code__line">                {</div><div class="c-code__line">                    Delimiter = <span class="c-code__stringliteral">&quot;,&quot;</span></div><div class="c-code__line">                });</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Write Header</span></div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span>(var header <span class="c-code__keywordflow">in</span> KeyFactory.Keys.Concat(Metric.Properties))</div><div class="c-code__line">                writer.WriteField(header);</div><div class="c-code__line">            writer.NextRecord();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Write Records</span></div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var record <span class="c-code__keywordflow">in</span> groups.OrderBy(i =&gt; i.Key))</div><div class="c-code__line">            {</div><div class="c-code__line">                var values = (record.Key + record.Value.ToString())</div><div class="c-code__line">                    .Split(<span class="c-code__charliteral">&#39;,&#39;</span>);</div><div class="c-code__line">                writer.WriteField(values);</div><div class="c-code__line">                writer.NextRecord();</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            writer.Flush();</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> Consumer[]</div><div class="c-code__line">            CreateConsumers(</div><div class="c-code__line">                IPipeline pipeline,</div><div class="c-code__line">                AreaIndex areaIndex,</div><div class="c-code__line">                KeyFactory factory,</div><div class="c-code__line">                BlockingCollection&lt;(<span class="c-code__keywordtype">string</span>, <span class="c-code__keywordtype">string</span>)&gt; ranges,</div><div class="c-code__line">                <span class="c-code__keywordtype">double</span> samplePercentage,</div><div class="c-code__line">                CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> Enumerable.Range(</div><div class="c-code__line">                0,</div><div class="c-code__line">                Environment.ProcessorCount).Select(_ =&gt;</div><div class="c-code__line">                {</div><div class="c-code__line">                    var consumer = <span class="c-code__keyword">new</span> Consumer();</div><div class="c-code__line">                    consumer.Task = Task.Factory.StartNew(() =&gt;</div><div class="c-code__line">                        ProcessRange(</div><div class="c-code__line">                            pipeline,</div><div class="c-code__line">                            areaIndex,</div><div class="c-code__line">                            factory,</div><div class="c-code__line">                            ranges,</div><div class="c-code__line">                            consumer,</div><div class="c-code__line">                            samplePercentage,</div><div class="c-code__line">                            stoppingToken),</div><div class="c-code__line">                        TaskCreationOptions.LongRunning);</div><div class="c-code__line">                    <span class="c-code__keywordflow">return</span> consumer;</div><div class="c-code__line">                }).ToArray();</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> AddRanges(</div><div class="c-code__line">            IpiOnPremiseEngine ipiEngine,</div><div class="c-code__line">            ILogger logger,</div><div class="c-code__line">            BlockingCollection&lt;(<span class="c-code__keywordtype">string</span>, <span class="c-code__keywordtype">string</span>)&gt; ranges,</div><div class="c-code__line">            Consumer[] consumers,</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            var process = Process.GetCurrentProcess();</div><div class="c-code__line">            var added = 0;</div><div class="c-code__line">            var lastLog = DateTime.UtcNow;</div><div class="c-code__line">            var nextLog = lastLog.Add(_logBuild);</div><div class="c-code__line">            var lastProcessorTime = process.TotalProcessorTime;</div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var range <span class="c-code__keywordflow">in</span> ipiEngine</div><div class="c-code__line">                .ValidRanges())</div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">try</span></div><div class="c-code__line">                {</div><div class="c-code__line">                    ranges.TryAdd(range, -1, stoppingToken);</div><div class="c-code__line">                    added++;</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (DateTime.UtcNow &gt;= nextLog)</div><div class="c-code__line">                    {</div><div class="c-code__line">                        nextLog = Log(</div><div class="c-code__line">                            logger, </div><div class="c-code__line">                            ranges, </div><div class="c-code__line">                            consumers, </div><div class="c-code__line">                            process, </div><div class="c-code__line">                            added, </div><div class="c-code__line">                            ref lastLog,</div><div class="c-code__line">                            ref lastProcessorTime, </div><div class="c-code__line">                            range);</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">catch</span> (OperationCanceledException)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__comment">// Do nothing and exit as if the ranges had been fully</span></div><div class="c-code__line">                    <span class="c-code__comment">// consumed.</span></div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">            ranges.CompleteAdding();</div><div class="c-code__line">            logger.LogInformation(<span class="c-code__stringliteral">&quot;Finished adding &#39;{0}&#39; ranges&quot;</span>, added);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> DateTime Log(</div><div class="c-code__line">            ILogger logger,</div><div class="c-code__line">            BlockingCollection&lt;(<span class="c-code__keywordtype">string</span>, <span class="c-code__keywordtype">string</span>)&gt; ranges,</div><div class="c-code__line">            Consumer[] consumers,</div><div class="c-code__line">            Process process,</div><div class="c-code__line">            <span class="c-code__keywordtype">int</span> added,</div><div class="c-code__line">            ref DateTime lastLog,</div><div class="c-code__line">            ref TimeSpan lastProcessorTime,</div><div class="c-code__line">            (<span class="c-code__keywordtype">string</span>, <span class="c-code__keywordtype">string</span>) range)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// Log the ranges and other telemetry.</span></div><div class="c-code__line">            logger.LogInformation(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;Processed &#39;{0}&#39; ranges with &#39;{1}&#39; in &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;queue, most recent &#39;{2}&#39;, and &#39;{3}&#39; &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;consumers&quot;</span>,</div><div class="c-code__line">                added,</div><div class="c-code__line">                ranges.Count,</div><div class="c-code__line">                range.Item1,</div><div class="c-code__line">                consumers.Count(i =&gt; i.Task.IsCompleted == <span class="c-code__keyword">false</span>));</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Get the elapsed time since last logged.</span></div><div class="c-code__line">            var elapsed = DateTime.UtcNow - lastLog;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// The amount of CPU used is the processor time</span></div><div class="c-code__line">            <span class="c-code__comment">// difference divided by the wall clock time</span></div><div class="c-code__line">            <span class="c-code__comment">// difference.</span></div><div class="c-code__line">            var cpu =</div><div class="c-code__line">                (process.TotalProcessorTime - lastProcessorTime) /</div><div class="c-code__line">                elapsed;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Work out the number of queries per second.</span></div><div class="c-code__line">            var total = consumers.Sum(i =&gt; i.Count);</div><div class="c-code__line">            var qps = total / elapsed.TotalSeconds;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Log the resource usage.</span></div><div class="c-code__line">            logger.LogInformation(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;&#39;{0:F2}&#39; processors used, &#39;{1:N0} qps, &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;&#39;{2}&#39; threads, &#39;{3}&#39; handles, and &#39;{4:N0}MB&#39; &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;memory used&quot;</span>,</div><div class="c-code__line">                cpu,</div><div class="c-code__line">                qps,</div><div class="c-code__line">                process.Threads.Count,</div><div class="c-code__line">                process.HandleCount,</div><div class="c-code__line">                process.WorkingSet64 / 1000);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Reset the count of queries to IPI.</span></div><div class="c-code__line">            <span class="c-code__keywordflow">foreach</span> (var consumer <span class="c-code__keywordflow">in</span> consumers)</div><div class="c-code__line">            {</div><div class="c-code__line">                consumer.Count = 0;</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Reset the other logging parameters.</span></div><div class="c-code__line">            lastLog = DateTime.UtcNow;</div><div class="c-code__line">            lastProcessorTime = process.TotalProcessorTime;</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> DateTime.UtcNow.Add(_logBuild);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> IReadOnlyDictionary&lt;string, Metric&gt; ProcessRange(</div><div class="c-code__line">            IPipeline pipeline,</div><div class="c-code__line">            AreaIndex dataSet,</div><div class="c-code__line">            KeyFactory factory,</div><div class="c-code__line">            BlockingCollection&lt;(<span class="c-code__keywordtype">string</span>, <span class="c-code__keywordtype">string</span>)&gt; ranges,</div><div class="c-code__line">            Consumer consumer,</div><div class="c-code__line">            <span class="c-code__keywordtype">double</span> samplePercentage,</div><div class="c-code__line">            CancellationToken stoppingToken)</div><div class="c-code__line">        {</div><div class="c-code__line">            var random = <span class="c-code__keyword">new</span> Random();</div><div class="c-code__line">            var groups = <span class="c-code__keyword">new</span> Dictionary&lt;string, Metric&gt;();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Allocate buffers outside the loop to avoid stack overflow warnings</span></div><div class="c-code__line">            Span&lt;byte&gt; ipBuffer = stackalloc <span class="c-code__keywordtype">byte</span>[16]; <span class="c-code__comment">// Max size for IPv6</span></div><div class="c-code__line">            Span&lt;byte&gt; endBuffer = stackalloc <span class="c-code__keywordtype">byte</span>[16];</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keywordflow">while</span> (ranges.IsCompleted == <span class="c-code__keyword">false</span> &amp;&amp;</div><div class="c-code__line">                stoppingToken.IsCancellationRequested == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">            {</div><div class="c-code__line">                <span class="c-code__keywordflow">try</span></div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__keywordflow">if</span> (ranges.TryTake(out var range, -1, stoppingToken))</div><div class="c-code__line">                    {</div><div class="c-code__line">                        var startIp = IPAddress.Parse(range.Item1);</div><div class="c-code__line">                        var endIp = IPAddress.Parse(range.Item2);</div><div class="c-code__line"></div><div class="c-code__line">                        <span class="c-code__comment">// Determine buffer size based on address family</span></div><div class="c-code__line">                        <span class="c-code__keywordtype">int</span> bufferSize = </div><div class="c-code__line">                            startIp.AddressFamily == </div><div class="c-code__line">                            AddressFamily.InterNetwork ? 4 : 16;</div><div class="c-code__line"></div><div class="c-code__line">                        <span class="c-code__comment">// Get the relevant slice of the buffer for this</span></div><div class="c-code__line">                        <span class="c-code__comment">// address family</span></div><div class="c-code__line">                        var currentIpBuffer = ipBuffer.Slice(</div><div class="c-code__line">                            0, </div><div class="c-code__line">                            bufferSize);</div><div class="c-code__line">                        var currentEndBuffer = endBuffer.Slice(</div><div class="c-code__line">                            0, </div><div class="c-code__line">                            bufferSize);</div><div class="c-code__line"></div><div class="c-code__line">                        startIp.TryWriteBytes(currentIpBuffer, out _);</div><div class="c-code__line">                        endIp.TryWriteBytes(currentEndBuffer, out _);</div><div class="c-code__line"></div><div class="c-code__line">                        <span class="c-code__keywordflow">while</span> (!<a class="code" href="class_extensions.html">Extensions</a>.<a class="code" href="class_extensions.html#a7533d059b15d1d1690abca59dbc3d4d2">IpEquals</a>(</div><div class="c-code__line">                            currentIpBuffer, </div><div class="c-code__line">                            currentEndBuffer) &amp;&amp;</div><div class="c-code__line">                            stoppingToken.IsCancellationRequested == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">                        {</div><div class="c-code__line">                            <span class="c-code__keywordflow">if</span> (random.NextDouble() &lt;= samplePercentage)</div><div class="c-code__line">                            {</div><div class="c-code__line">                                <span class="c-code__comment">// Only allocate IPAddress object when we</span></div><div class="c-code__line">                                <span class="c-code__comment">// actually need to process it</span></div><div class="c-code__line">                                var ip = <span class="c-code__keyword">new</span> IPAddress(currentIpBuffer);</div><div class="c-code__line">                                ProcessIp(</div><div class="c-code__line">                                    pipeline,</div><div class="c-code__line">                                    dataSet,</div><div class="c-code__line">                                    groups,</div><div class="c-code__line">                                    factory,</div><div class="c-code__line">                                    ip);</div><div class="c-code__line">                                consumer.Count++;</div><div class="c-code__line">                            }</div><div class="c-code__line"></div><div class="c-code__line">                            <span class="c-code__comment">// Increment to next IP address (operates on stack</span></div><div class="c-code__line">                            <span class="c-code__comment">// buffer, no allocation)</span></div><div class="c-code__line">                            <span class="c-code__keywordflow">if</span> (!<a class="code" href="class_extensions.html">Extensions</a>.<a class="code" href="class_extensions.html#a7767954cb4226897a310649b2e17641c">TryGetNextAddress</a>(currentIpBuffer))</div><div class="c-code__line">                                <span class="c-code__keywordflow">break</span>; <span class="c-code__comment">// Overflow, reached maximum IP</span></div><div class="c-code__line">                        }</div><div class="c-code__line">                    }</div><div class="c-code__line">                }</div><div class="c-code__line">                <span class="c-code__keywordflow">catch</span> (OperationCanceledException)</div><div class="c-code__line">                {</div><div class="c-code__line">                    <span class="c-code__comment">// Do nothing and exit the consumer.</span></div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> groups;</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keyword">private</span> <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> ProcessIp(</div><div class="c-code__line">            IPipeline pipeline,</div><div class="c-code__line">            AreaIndex dataSet,</div><div class="c-code__line">            Dictionary&lt;string, Metric&gt; groups,</div><div class="c-code__line">            KeyFactory factory,</div><div class="c-code__line">            IPAddress ipAddress)</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// Get the data for the IP address.</span></div><div class="c-code__line">            <span class="c-code__keyword">using</span> var flowData = pipeline.CreateFlowData();</div><div class="c-code__line">            flowData.AddEvidence(<span class="c-code__stringliteral">&quot;query.client-ip&quot;</span>, ipAddress.ToString());</div><div class="c-code__line">            flowData.Process();</div><div class="c-code__line">            var data = flowData.Get&lt;IIpIntelligenceData&gt;();</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Get the metric instance for the group key.</span></div><div class="c-code__line">            var key = factory.Create(data);</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (groups.TryGetValue(key, out var metric) == <span class="c-code__keyword">false</span>)</div><div class="c-code__line">            {</div><div class="c-code__line">                metric = <span class="c-code__keyword">new</span> Metric();</div><div class="c-code__line">                groups.Add(key, metric);</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Increase the number of IP addresses that relate to this key.</span></div><div class="c-code__line">            metric.IpCount++;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Increase the total area and number of areas for the metric only</span></div><div class="c-code__line">            <span class="c-code__comment">// where a non zero area is available.</span></div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (data.Areas.HasValue &amp;&amp; </div><div class="c-code__line">                dataSet.WktAreas.TryGetValue(</div><div class="c-code__line">                    data.Areas.Value,</div><div class="c-code__line">                    out var value) &amp;&amp; </div><div class="c-code__line">                value != <span class="c-code__keyword">null</span>)</div><div class="c-code__line">            {</div><div class="c-code__line">                metric.TotalAreaKm += value.SquareKms;</div><div class="c-code__line">                metric.IncrementPolygons(value.Geometries);</div><div class="c-code__line">                metric.AreaCount++;</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> Main(<span class="c-code__keywordtype">string</span>[] args)</div><div class="c-code__line">    {</div><div class="c-code__line">        var configuration = <span class="c-code__keyword">new</span> Configuration</div><div class="c-code__line">        {</div><div class="c-code__line">            <span class="c-code__comment">// Use the supplied path for the data file or find the lite file that is included</span></div><div class="c-code__line">            <span class="c-code__comment">// in the repository.</span></div><div class="c-code__line">            DataFile = args.Length &gt; 0 ? args[0] :</div><div class="c-code__line">            <span class="c-code__comment">// In this example, by default, the 51degrees IP Intelligence data file needs to be somewhere in the</span></div><div class="c-code__line">            <span class="c-code__comment">// project space, or you may specify another file as a command line parameter.</span></div><div class="c-code__line">            <span class="c-code__comment">//</span></div><div class="c-code__line">            <span class="c-code__comment">// For testing, contact us to obtain an enterprise data file: https://51degrees.com/contact-us</span></div><div class="c-code__line">            Examples.ExampleUtils.FindFile(</div><div class="c-code__line">                Constants.ENTERPRISE_IPI_DATA_FILE_NAME)</div><div class="c-code__line">        };</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Get the location for the output file. Use the same location as the</span></div><div class="c-code__line">        <span class="c-code__comment">// evidence if a path is not supplied on the command line.</span></div><div class="c-code__line">        var outputFile = args.Length &gt; 1 ? args[1] : <span class="c-code__stringliteral">&quot;metrics-output.csv&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Get the sample percentage or use the default.</span></div><div class="c-code__line">        configuration.SamplePercentage = args.Length &gt; 2 ?</div><div class="c-code__line">            <span class="c-code__keywordtype">double</span>.Parse(args[2]) :</div><div class="c-code__line">            DEFAULT_SAMPLE_PERCENTAGE;</div><div class="c-code__line"></div><div class="c-code__line">        File.WriteAllText(<span class="c-code__stringliteral">&quot;Metrics_DataFileName.txt&quot;</span>, configuration.DataFile);</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Configure a logger to output to the console with timestamps.</span></div><div class="c-code__line">        configuration.LoggerFactory = LoggerFactory.Create(b =&gt;</div><div class="c-code__line">            b.AddSimpleConsole(options =&gt;</div><div class="c-code__line">            {</div><div class="c-code__line">                options.IncludeScopes = false;</div><div class="c-code__line">                options.SingleLine = true;</div><div class="c-code__line">                options.TimestampFormat = <span class="c-code__stringliteral">&quot;yyyy-MM-dd HH:mm:ss &quot;</span>;</div><div class="c-code__line">            }));</div><div class="c-code__line">        var logger = configuration.LoggerFactory.CreateLogger&lt;<a class="code" href="class_program.html">Program</a>&gt;();</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (configuration.DataFile != <span class="c-code__keyword">null</span>)</div><div class="c-code__line">        {</div><div class="c-code__line">            logger.LogInformation($<span class="c-code__stringliteral">&quot;Found IPI data file: {configuration.DataFile}&quot;</span>);</div><div class="c-code__line">            <span class="c-code__keyword">using</span> var output = File.CreateText(outputFile);</div><div class="c-code__line">            configuration.<a name="a28"></a><a class="code" href="class_program.html#adf4fe232dbc7930c5ff8d4966b2c48a0">Output</a> = output;</div><div class="c-code__line">            var builder = Host.CreateApplicationBuilder([]);</div><div class="c-code__line">            builder.Services.AddSingleton(configuration);</div><div class="c-code__line">            builder.Services.AddHostedService&lt;<a class="code" href="class_program.html#a898dc758806b6d5937f2fd6382eebd91">Worker</a>&gt;();</div><div class="c-code__line">            <span class="c-code__keyword">using</span> var host = builder.Build();</div><div class="c-code__line">            host.Run();</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span></div><div class="c-code__line">        {</div><div class="c-code__line">            logger.LogError(<span class="c-code__stringliteral">&quot;Failed to find a IP Intelligence data file. Make sure the &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;ip-intelligence-data submodule has been updated by running &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;`git submodule update --recursive`. By default, the &#39;lite&#39; file included &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;with this code will be used. A different file can be specified &quot;</span> +</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;by supplying the full path as a command line argument&quot;</span>);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Dispose the logger to ensure any messages get flushed</span></div><div class="c-code__line">        configuration.LoggerFactory.Dispose();</div><div class="c-code__line">    }</div><div class="c-code__line">}</div></div> </div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
